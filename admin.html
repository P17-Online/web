<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>P17-Online — Panel Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#eaf6fb;--card:#ffffff;--primary:#0d62ff;--muted:#66737f;--rounded:12px}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;color:#07203a;background:linear-gradient(180deg,#eaf6fb,#f6fbff);min-height:100vh}
    .container{width:92%;max-width:980px;margin:28px auto}
    header{display:flex;align-items:center;gap:12px}
    header img{width:48px;height:48px}
    .title{font-weight:700;font-size:20px}

    .login-card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,0.06)}
    .login-card h2{margin-top:0}
    .field{margin-bottom:10px}
    input[type=text], input[type=password], textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #dfe8f4}
    button{background:var(--primary);color:white;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}

    .panel{display:none}
    .panel.active{display:block}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:20px}
    .card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 16px rgba(2,6,23,0.06);border:1px solid rgba(2,6,23,0.04)}
    .list{max-height:560px;overflow:auto}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;text-align:left;border-bottom:1px solid #f0f4fb}
    .small{font-size:13px;color:var(--muted)}
    .actions button{margin-right:6px}

    .form-row{display:flex;gap:8px}
    .form-row .col{flex:1}
    .muted{color:var(--muted);font-size:13px}

    .disabled{opacity:0.6;pointer-events:none}

    @media(max-width:860px){.grid{grid-template-columns:1fr}.list{max-height:360px}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="https://cdn-icons-png.flaticon.com/512/3135/3135810.png" alt="logo">
      <div>
        <div class="title">P17-Online — Panel Administrativo</div>
        <div class="small">Administra las publicaciones públicas</div>
      </div>
    </header>

    <div id="login" class="login-card" style="margin-top:18px">
      <h2>Acceso Administrador</h2>
      <p class="muted">Introduce la contraseña para acceder al panel.</p>
      <div class="field"><input id="pwd" type="password" placeholder="Contraseña"></div>
      <div class="field"><button id="btnLogin">Entrar</button></div>
      <div id="loginMsg" class="muted"></div>
      <div id="clientStatus" class="muted" style="margin-top:8px">Cargando cliente Supabase...</div>
    </div>

    <div id="panel" class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin:12px 0">
        <div class="muted">Sesión admin — protegido por contraseña</div>
        <div><button id="btnLogout" style="background:#f44336">Cerrar sesión</button></div>
      </div>

      <div class="grid">
        <div>
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <strong>Publicaciones</strong>
              <div class="muted">Actualiza, edita o elimina</div>
            </div>
            <div class="list" id="listContainer">
              <p class="muted">Cargando publicaciones...</p>
            </div>
          </div>
        </div>

        <div>
          <div class="card">
            <strong id="formTitle">Agregar publicación</strong>
            <div class="muted" style="margin-bottom:10px">Llena los campos y presiona Guardar</div>

            <div style="margin-bottom:8px"><input id="categoria" type="text" placeholder="Categoría (noticias, anuncios, eventos, negocios)"></div>
            <div style="margin-bottom:8px"><input id="titulo" type="text" placeholder="Título"></div>
            <div style="margin-bottom:8px"><textarea id="descripcion" rows="5" placeholder="Descripción"></textarea></div>
            <div style="margin-bottom:8px"><input id="imagenUrl" type="text" placeholder="URL de imagen (opcional)"></div>
            <div style="margin-bottom:8px"><input id="imagenFile" type="file" accept="image/*"></div>

            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
              <button id="btnSave">Guardar</button>
              <button id="btnCancel" style="background:#999">Cancelar</button>
            </div>

            <div id="formMsg" class="muted" style="margin-top:8px"></div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script id="supabase-js" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <script>

    const SUPABASE_URL = 'https://ayvkdglarrpounfvxqle.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF5dmtkZ2xhcnJwb3VuZnZ4cWxlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NzQ0ODcsImV4cCI6MjA3NTQ1MDQ4N30.GM1SCSGOH4ly8WIMKrkV85440NhmJ2NyIfhoOweaPZw';
    const STORAGE_BUCKET = 'publicaciones'; 
    const ADMIN_PASSWORD = 'p17online9791'; 

    const $ = id => document.getElementById(id);
    const clientStatus = $('clientStatus');

    function waitForSupabase(timeout = 5000){
      return new Promise((resolve, reject) => {
        if(window.supabase && typeof window.supabase.createClient === 'function') return resolve(window.supabase);

        const script = document.getElementById('supabase-js');
        let done = false;

        function checkAndResolve(){
          if(done) return;
          if(window.supabase && typeof window.supabase.createClient === 'function'){
            done = true; resolve(window.supabase);
            return;
          }
        }

        script.addEventListener('load', () => { checkAndResolve(); });
        script.addEventListener('error', (e) => { if(!done){ done = true; reject(new Error('No se pudo cargar el script de Supabase')); } });

        const interval = setInterval(()=>{
          if(done) return clearInterval(interval);
          if(window.supabase && typeof window.supabase.createClient === 'function'){
            done = true; clearInterval(interval); resolve(window.supabase);
          }
        }, 50);

        setTimeout(()=>{
          if(done) return; done = true; reject(new Error('Timeout esperando Supabase')); }, timeout);
      });
    }

    (async function init(){
      try{
        clientStatus.textContent = 'Esperando cliente Supabase...';
        await waitForSupabase(8000);
        clientStatus.textContent = 'Cliente Supabase listo.';

        window._supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        initAdminUI(window._supabaseClient);

      }catch(err){
        console.error('Error inicializando Supabase:', err);
        clientStatus.textContent = 'Error cargando Supabase: '+ (err.message || err);
        $('btnLogin').classList.add('disabled');
      }
    })();

    function initAdminUI(supabase){
      const formatDate = d => new Date(d).toLocaleString();
      function escapeHtml(s){ return String(s||'').replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])) }

      function isLogged(){ return sessionStorage.getItem('p17_admin') === '1'; }
      function doLogin(pwd){ if(pwd === ADMIN_PASSWORD){ sessionStorage.setItem('p17_admin','1'); return true } return false }
      function doLogout(){ sessionStorage.removeItem('p17_admin'); }

      const loginEl = $('login');
      const panelEl = $('panel');
      const listContainer = $('listContainer');
      const formTitle = $('formTitle');

      const categoriaIn = $('categoria');
      const tituloIn = $('titulo');
      const descripcionIn = $('descripcion');
      const imagenUrlIn = $('imagenUrl');
      const imagenFileIn = $('imagenFile');
      const formMsg = $('formMsg');

      let editingId = null;

      async function loadPublicaciones(){
        listContainer.innerHTML = '<p class="muted">Cargando publicaciones...</p>';
        try{
          const { data, error } = await supabase.from('publicaciones').select('*').order('fecha', { ascending: false });
          if(error){ throw error }
          if(!data || data.length===0){ listContainer.innerHTML = '<p class="muted">No hay publicaciones.</p>'; return }

          const rows = data.map(r => {
            const img = r.imagen ? `<img src="${escapeHtml(r.imagen)}" style="width:80px;height:48px;object-fit:cover;border-radius:6px;margin-right:8px">` : '';
            return `\n          <div style="display:flex;align-items:center;padding:8px;border-bottom:1px solid #f0f4fb">\n            <div style="flex:1;display:flex;align-items:center">${img}<div>\n              <div style="font-weight:700">${escapeHtml(r.titulo||'--')}</div>\n              <div class="small">${escapeHtml(r.categoria||'--')} · ${formatDate(r.fecha||new Date())}</div>\n            </div></div>\n            <div class="actions">\n              <button data-id="${r.id}" class="edit">Editar</button>\n              <button data-id="${r.id}" class="del" style="background:#f44336">Eliminar</button>\n            </div>\n          </div>\n        `;
          }).join('');

          listContainer.innerHTML = rows;

          listContainer.querySelectorAll('button.edit').forEach(b => b.addEventListener('click', ()=> startEdit(b.dataset.id)));
          listContainer.querySelectorAll('button.del').forEach(b => b.addEventListener('click', ()=> doDelete(b.dataset.id)));

        }catch(err){ console.error(err); listContainer.innerHTML = '<p class="muted">Error al cargar publicaciones.</p>'; }
      }

      async function startEdit(id){
        try{
          const { data, error } = await supabase.from('publicaciones').select('*').eq('id', id).single();
          if(error) throw error;
          editingId = id;
          formTitle.textContent = 'Editar publicación (ID: '+id+')';
          categoriaIn.value = data.categoria || '';
          tituloIn.value = data.titulo || '';
          descripcionIn.value = data.descripcion || '';
          imagenUrlIn.value = data.imagen || '';
          window.scrollTo({top:0,behavior:'smooth'});
        }catch(err){ alert('No se pudo cargar el item'); console.error(err); }
      }

      $('btnCancel').addEventListener('click', (e)=>{ e.preventDefault(); resetForm(); });

      function resetForm(){ editingId = null; formTitle.textContent = 'Agregar publicación'; categoriaIn.value=''; tituloIn.value=''; descripcionIn.value=''; imagenUrlIn.value=''; imagenFileIn.value=''; formMsg.textContent=''; }

      async function doDelete(id){ if(!confirm('¿Eliminar publicación ID '+id+'?')) return;
        try{
          const { error } = await supabase.from('publicaciones').delete().eq('id', id);
          if(error) throw error;
          await loadPublicaciones();
        }catch(err){ alert('Error al eliminar'); console.error(err); }
      }

      async function uploadFile(file){
        if(!file) return null;
        if(!STORAGE_BUCKET) return null;
        const filename = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.-]/g,'_')}`;
        try{
          const { data, error } = await supabase.storage.from(STORAGE_BUCKET).upload(filename, file, {cacheControl:'3600', upsert:false});
          if(error) throw error;
          const { publicURL } = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(data.path);
          return publicURL || null;
        }catch(err){ console.error('Storage upload error', err); return null }
      }

      $('btnSave').addEventListener('click', async (e)=>{
        e.preventDefault();
        formMsg.textContent = 'Guardando...';

        const categoria = categoriaIn.value.trim();
        const titulo = tituloIn.value.trim();
        const descripcion = descripcionIn.value.trim();
        let imagen = imagenUrlIn.value.trim() || null;

        if(imagenFileIn.files && imagenFileIn.files.length>0 && STORAGE_BUCKET){
          const uploaded = await uploadFile(imagenFileIn.files[0]);
          if(uploaded) imagen = uploaded;
        }

        if(!categoria || !titulo){ formMsg.textContent = 'Categoria y título son obligatorios'; return }

        try{
          if(editingId){
            const { error } = await supabase.from('publicaciones').update({ categoria, titulo, descripcion, imagen, fecha: new Date().toISOString() }).eq('id', editingId);
            if(error) throw error;
            formMsg.textContent = 'Actualizado';
          } else {
            const { error } = await supabase.from('publicaciones').insert([{ categoria, titulo, descripcion, imagen, fecha: new Date().toISOString() }]);
            if(error) throw error;
            formMsg.textContent = 'Publicado';
          }
          resetForm();
          await loadPublicaciones();
        }catch(err){ console.error(err); formMsg.textContent = 'Error en guardar'; }
      });

      $('btnLogin').addEventListener('click', ()=>{
        const v = $('pwd').value || '';
        if(doLogin(v)){ showPanel(); } else { $('loginMsg').textContent = 'Contraseña incorrecta'; }
      });
      $('btnLogout').addEventListener('click', ()=>{ doLogout(); showPanel(); });

      function showPanel(){ if(isLogged()){ loginEl.style.display='none'; panelEl.classList.add('active'); loadPublicaciones(); } else { loginEl.style.display='block'; panelEl.classList.remove('active'); } }

      if(isLogged()) showPanel();

      $('pwd').addEventListener('keyup', (e)=>{ if(e.key === 'Enter'){ $('btnLogin').click(); } });

    } 
  </script>
</body>
</html>
